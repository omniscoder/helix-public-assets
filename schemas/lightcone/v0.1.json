{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "v0.1.json",
  "title": "Helix Lightcone Outcome Set (v0.1)",
  "type": "object",
  "additionalProperties": false,
  "required": ["specVersion", "id", "locus", "editType", "outcomes"],
  "properties": {
    "specVersion": { "const": "v0.1" },
    "id": { "type": "string", "minLength": 1 },
    "notes": { "type": "string" },
    "locus": { "$ref": "#/$defs/locus" },
    "editType": {
      "type": "string",
      "enum": ["crispr_cut", "cas_nick", "prime_edit", "base_edit"]
    },
    "builderProvenance": {
      "type": "object",
      "additionalProperties": false,
      "required": ["builderId", "seed", "referenceWindowSha256"],
      "properties": {
        "builderId": { "type": "string", "minLength": 1 },
        "builderVersion": { "type": "string" },
        "seed": { "type": "integer" },
        "params": { "type": "object", "additionalProperties": true },
        "referenceWindowSha256": { "$ref": "#/$defs/sha256Hex" },
        "notes": { "type": "string" }
      }
    },
    "phaseModel": {
      "type": "object",
      "additionalProperties": false,
      "required": ["stages"],
      "properties": {
        "stages": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["name", "start", "end"],
            "properties": {
              "name": {
                "type": "string",
                "enum": ["bind", "cut_or_nick", "processing", "synthesis", "ligation"]
              },
              "start": { "type": "number", "minimum": 0.0, "maximum": 1.0 },
              "end": { "type": "number", "minimum": 0.0, "maximum": 1.0 }
            }
          }
        }
      }
    },
    "referenceWindow": {
      "type": "object",
      "additionalProperties": false,
      "required": ["start", "end"],
      "properties": {
        "start": { "type": "integer" },
        "end": { "type": "integer" },
        "sequence": { "type": "string" },
        "checksum": { "type": "string" }
      }
    },
    "outcomes": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/outcome" }
    },
    "offTargets": {
      "type": "array",
      "items": { "$ref": "#/$defs/offTarget" }
    },
    "renderGolden": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "renderer",
        "width",
        "height",
        "phase",
        "seed",
        "background",
        "camera",
        "projection",
        "colorSpace",
        "alphaMode",
        "compositeSpace",
        "style",
        "settingsSha256",
        "rgbaSha256"
      ],
      "properties": {
        "renderer": { "$ref": "#/$defs/renderer" },
        "width": { "type": "integer", "minimum": 32, "maximum": 4096 },
        "height": { "type": "integer", "minimum": 32, "maximum": 4096 },
        "phase": { "type": "number", "minimum": 0.0, "maximum": 1.0 },
        "seed": { "type": "integer" },
        "background": { "$ref": "#/$defs/rgba8" },
        "camera": { "$ref": "#/$defs/camera2d" },
        "projection": { "$ref": "#/$defs/projection2d" },
        "colorSpace": { "type": "string", "enum": ["srgb8"] },
        "alphaMode": { "type": "string", "enum": ["straight"] },
        "compositeSpace": { "type": "string", "enum": ["srgb"] },
        "style": { "$ref": "#/$defs/style" },
        "settingsSha256": { "$ref": "#/$defs/sha256Hex" },
        "tolerance": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "maxAbsDiff": { "type": "integer", "minimum": 0, "maximum": 255 },
            "meanAbsDiff": { "type": "number", "minimum": 0.0, "maximum": 255.0 }
          }
        },
        "rgbaSha256": { "$ref": "#/$defs/sha256Hex" },
        "geometrySha256": { "$ref": "#/$defs/sha256Hex" }
      }
    }
  },
  "$defs": {
    "sha256Hex": {
      "type": "string",
      "pattern": "^[0-9a-f]{64}$"
    },
    "rgb8": {
      "type": "array",
      "minItems": 3,
      "maxItems": 3,
      "items": { "type": "integer", "minimum": 0, "maximum": 255 }
    },
    "rgba8": {
      "type": "array",
      "minItems": 4,
      "maxItems": 4,
      "items": { "type": "integer", "minimum": 0, "maximum": 255 }
    },
    "styleRule": {
      "type": "object",
      "additionalProperties": false,
      "required": ["matchAny"],
      "properties": {
        "matchAny": { "type": "array", "minItems": 1, "items": { "type": "string" } },
        "colorRgb": { "$ref": "#/$defs/rgb8" },
        "thicknessMul": { "type": "number", "minimum": 0.0 },
        "braid": { "type": "boolean" }
      }
    },
    "style": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "version",
        "layoutMode",
        "margins",
        "trunkColor",
        "trunkRadiusPx",
        "branchRadiusPx",
        "tipRadiusPx",
        "tipAlphaBoost",
        "alphaBase",
        "alphaScale",
        "alphaMin",
        "alphaMax",
        "laneSpreadPx",
        "laneSpreadFrac",
        "baseEditLaneSpreadPx",
        "baseEditLaneSpreadFrac",
        "deltaBpScalePx",
        "deltaBpClampPx",
        "treeMaxSpreadPx",
        "treeLeafJitterPx",
        "bundling",
        "ghosts",
        "baseSheen",
        "defaultColorRgb",
        "tagRules"
      ],
      "properties": {
        "version": { "const": "v0.1" },
        "layoutMode": { "type": "string", "enum": ["lanes_v0", "tree_v1"] },
        "margins": {
          "type": "object",
          "additionalProperties": false,
          "required": ["left", "right", "top", "bottom"],
          "properties": {
            "left": { "type": "integer", "minimum": 0, "maximum": 256 },
            "right": { "type": "integer", "minimum": 0, "maximum": 256 },
            "top": { "type": "integer", "minimum": 0, "maximum": 256 },
            "bottom": { "type": "integer", "minimum": 0, "maximum": 256 }
          }
        },
        "trunkColor": { "$ref": "#/$defs/rgba8" },
        "trunkRadiusPx": { "type": "integer", "minimum": 0, "maximum": 64 },
        "branchRadiusPx": { "type": "integer", "minimum": 0, "maximum": 64 },
        "tipRadiusPx": { "type": "integer", "minimum": 0, "maximum": 64 },
        "tipAlphaBoost": { "type": "integer", "minimum": 0, "maximum": 255 },
        "alphaBase": { "type": "integer", "minimum": 0, "maximum": 255 },
        "alphaScale": { "type": "integer", "minimum": 0, "maximum": 255 },
        "alphaMin": { "type": "integer", "minimum": 0, "maximum": 255 },
        "alphaMax": { "type": "integer", "minimum": 0, "maximum": 255 },
        "laneSpreadPx": { "type": "number", "minimum": 0.0, "maximum": 2048.0 },
        "laneSpreadFrac": { "type": "number", "minimum": 0.0, "maximum": 4.0 },
        "baseEditLaneSpreadPx": { "type": "number", "minimum": 0.0, "maximum": 2048.0 },
        "baseEditLaneSpreadFrac": { "type": "number", "minimum": 0.0, "maximum": 4.0 },
        "deltaBpScalePx": { "type": "number", "minimum": 0.0, "maximum": 64.0 },
        "deltaBpClampPx": { "type": "number", "minimum": 0.0, "maximum": 2048.0 },
        "treeMaxSpreadPx": { "type": "number", "minimum": 0.0, "maximum": 2048.0 },
        "treeLeafJitterPx": { "type": "number", "minimum": 0.0, "maximum": 64.0 },
        "bundling": { "type": "object", "additionalProperties": true },
        "ghosts": { "type": "object", "additionalProperties": true },
        "baseSheen": { "type": "object", "additionalProperties": true },
        "defaultColorRgb": { "$ref": "#/$defs/rgb8" },
        "tagRules": { "type": "array", "items": { "$ref": "#/$defs/styleRule" } }
      }
    },
    "renderer": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "version"],
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "version": { "type": "string", "minLength": 1 },
        "shaderSha256": { "$ref": "#/$defs/sha256Hex" }
      }
    },
    "camera2d": {
      "type": "object",
      "additionalProperties": false,
      "required": ["kind", "panPx", "zoom"],
      "properties": {
        "kind": { "const": "lightcone2d" },
        "panPx": {
          "type": "array",
          "minItems": 2,
          "maxItems": 2,
          "items": { "type": "number" }
        },
        "zoom": { "type": "number", "minimum": 0.01, "maximum": 100.0 }
      }
    },
    "projection2d": {
      "type": "object",
      "additionalProperties": false,
      "required": ["kind", "phaseDirection"],
      "properties": {
        "kind": { "const": "pixel_ortho" },
        "phaseDirection": { "type": "string", "enum": ["up"] }
      }
    },
    "locus": {
      "type": "object",
      "additionalProperties": false,
      "required": ["contig", "position", "strand", "windowStart", "windowEnd"],
      "properties": {
        "contig": { "type": "string", "minLength": 1 },
        "position": { "type": "integer" },
        "strand": { "type": "string", "enum": ["+", "-"] },
        "windowStart": { "type": "integer" },
        "windowEnd": { "type": "integer" }
      }
    },
    "alleleOp": {
      "type": "object",
      "additionalProperties": false,
      "required": ["op"],
      "properties": {
        "op": { "type": "string", "enum": ["match", "sub", "ins", "del"] },
        "n": { "type": "integer", "minimum": 0 },
        "ref": { "type": "string" },
        "alt": { "type": "string" },
        "seq": { "type": "string" }
      },
      "allOf": [
        {
          "if": { "properties": { "op": { "const": "match" } } },
          "then": { "required": ["n"] }
        },
        {
          "if": { "properties": { "op": { "const": "del" } } },
          "then": { "required": ["n"] }
        },
        {
          "if": { "properties": { "op": { "const": "ins" } } },
          "then": { "required": ["seq"] }
        },
        {
          "if": { "properties": { "op": { "const": "sub" } } },
          "then": { "required": ["ref", "alt"] }
        }
      ]
    },
    "outcome": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "probability", "divergencePhase", "alleleOps"],
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "probability": { "type": "number", "minimum": 0.0, "maximum": 1.0 },
        "divergencePhase": { "type": "number", "minimum": 0.0, "maximum": 1.0 },
        "mechanismTags": { "type": "array", "items": { "type": "string" } },
        "notes": { "type": "string" },
        "alleleOps": { "type": "array", "minItems": 1, "items": { "$ref": "#/$defs/alleleOp" } }
      }
    },
    "offTarget": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "locus", "mismatchSignature", "probabilityMass"],
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "locus": { "$ref": "#/$defs/locus" },
        "probabilityMass": { "type": "number", "minimum": 0.0, "maximum": 1.0 },
        "mismatchSignature": {
          "type": "object",
          "additionalProperties": false,
          "required": ["totalMismatches", "mismatches"],
          "properties": {
            "pam": { "type": "string" },
            "totalMismatches": { "type": "integer", "minimum": 0 },
            "mismatches": {
              "type": "array",
              "items": {
                "type": "object",
                "additionalProperties": false,
                "required": ["index"],
                "properties": {
                  "index": { "type": "integer", "minimum": 0 },
                  "ref": { "type": "string" },
                  "alt": { "type": "string" }
                }
              }
            }
          }
        }
      }
    }
  }
}
